# ä»£ç å®¡æŸ¥æ€»ç»“

## ğŸ”´ ä¸¥é‡é—®é¢˜ (å¿…é¡»ä¿®å¤)
**æ— ä¸¥é‡é—®é¢˜** - æ‰€æœ‰ä¿®æ”¹éƒ½æ˜¯åˆç†çš„ä»£ç æ”¹è¿›

## ğŸŸ¢ ä¼˜åŒ–å»ºè®® (å¯é€‰)
1. **ç‰ˆæœ¬å·ç¡¬ç¼–ç **: pingè·¯ç”±ä¸­çš„ç‰ˆæœ¬å·"1.6.0"åº”è¯¥ä»package.jsonåŠ¨æ€è·å–
2. **å›¾æ ‡æ–‡ä»¶**: favicon.icoå’Œlogo.pngçš„äºŒè¿›åˆ¶æ–‡ä»¶å˜æ›´æ— æ³•å®¡æŸ¥å†…å®¹

## âœ… ä¼˜ç§€å®è·µ
1. **ç»Ÿä¸€æ—¥å¿—è®°å½•**: å°†console.log/console.erroræ›¿æ¢ä¸ºç»“æ„åŒ–çš„logger
2. **é‚®ç®±éªŒè¯é‡æ„**: æå–é‚®ç®±éªŒè¯é€»è¾‘åˆ°ç‹¬ç«‹çš„å·¥å…·å‡½æ•°
3. **é‡è¯•æœºåˆ¶ä¼˜åŒ–**: ç®€åŒ–å¹¶ç»Ÿä¸€é‡è¯•é€»è¾‘ï¼Œä½¿ç”¨æŒ‡æ•°é€€é¿ç­–ç•¥
4. **é”™è¯¯å¤„ç†æ”¹è¿›**: ä½¿ç”¨æ›´åˆé€‚çš„HTTPçŠ¶æ€ç (400è€Œé500)
5. **ä»£ç ç®€åŒ–**: ç§»é™¤å¤æ‚çš„è¯·æ±‚å»é‡å’Œè¿æ¥ç®¡ç†é€»è¾‘
6. **å¥åº·æ£€æŸ¥ç«¯ç‚¹**: ä¸ºpingè·¯ç”±æ·»åŠ GETæ–¹æ³•ç”¨äºå¤–éƒ¨ç›‘æ§

## æ¯è¡Œä¿®æ”¹çš„å¿…è¦æ€§åˆ†æ
âœ… **æ‰€æœ‰ä¿®æ”¹éƒ½æ˜¯å¿…è¦çš„**:
- æ—¥å¿—è®°å½•æ ‡å‡†åŒ–æå‡äº†å¯ç»´æŠ¤æ€§
- é‚®ç®±éªŒè¯é€»è¾‘å¤ç”¨å‡å°‘äº†ä»£ç é‡å¤
- é‡è¯•æœºåˆ¶ç®€åŒ–æé«˜äº†ä»£ç å¯è¯»æ€§
- é”™è¯¯çŠ¶æ€ç ä¿®æ­£ç¬¦åˆHTTPæ ‡å‡†
- å¥åº·æ£€æŸ¥ç«¯ç‚¹æ»¡è¶³ç›‘æ§éœ€æ±‚

## å®‰å…¨æ€§æ£€æŸ¥
âœ… **æ— æ•æ„Ÿä¿¡æ¯æ³„éœ²** - æ‰€æœ‰ä¿®æ”¹éƒ½æ˜¯å®‰å…¨çš„ä»£ç æ”¹è¿›

## å»ºè®®çš„Commitä¿¡æ¯
```
refactor: ç»Ÿä¸€æ—¥å¿—è®°å½•å’Œä¼˜åŒ–é”™è¯¯å¤„ç†

- å°†console.log/erroræ›¿æ¢ä¸ºç»“æ„åŒ–logger
- æå–é‚®ç®±éªŒè¯é€»è¾‘åˆ°ç‹¬ç«‹å·¥å…·å‡½æ•°
- ç®€åŒ–æ•°æ®åº“é‡è¯•æœºåˆ¶ï¼Œä½¿ç”¨æŒ‡æ•°é€€é¿ç­–ç•¥
- ä¿®æ­£é‚®ç®±æœªæ³¨å†Œé”™è¯¯çš„HTTPçŠ¶æ€ç (500->400)
- ä¸ºpingç«¯ç‚¹æ·»åŠ GETæ–¹æ³•ç”¨äºå¥åº·æ£€æŸ¥
- ç§»é™¤å¤æ‚çš„è¯·æ±‚å»é‡å’Œè¿æ¥ç®¡ç†é€»è¾‘
- æ›´æ–°faviconå’Œlogoå›¾æ ‡
```

---

diff --git a/app/api/checkout/route.ts b/app/api/checkout/route.ts
index fb0e58d..e95c748 100644
--- a/app/api/checkout/route.ts
+++ b/app/api/checkout/route.ts
@@ -6,6 +6,7 @@ import { Order } from "@/types/order";
 import Stripe from "stripe";
 import { findUserByUuid } from "@/models/user";
 import { getSnowId } from "@/lib/hash";
+import { log } from "@/lib/logger";
 
 export async function POST(req: Request) {
   try {
@@ -169,7 +170,7 @@ export async function POST(req: Request) {
       session_id: stripe_session_id,
     });
   } catch (e: any) {
-    console.log("checkout failed: ", e);
+    log.error("checkout failed", e as Error, { function: 'checkout' });
     return respErr("checkout failed: " + e.message);
   }
 }
diff --git a/app/api/email-register/route.ts b/app/api/email-register/route.ts
index 70d0c44..77dd320 100644
--- a/app/api/email-register/route.ts
+++ b/app/api/email-register/route.ts
@@ -10,6 +10,7 @@ import { getOneYearLaterTimestr } from "@/lib/time";
 import { emailService } from "@/services/email";
 import { DEFAULT_AVATAR_URL, PASSWORD_CONFIG } from "@/lib/constants";
 import { log } from "@/lib/logger";
+import { isValidEmail } from "@/lib/email-validator";
 import bcrypt from "bcrypt";
 
 export async function POST(request: NextRequest) {
@@ -59,8 +60,7 @@ export async function POST(request: NextRequest) {
     }
 
     // éªŒè¯é‚®ç®±æ ¼å¼
-    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
-    if (!emailRegex.test(email)) {
+    if (!isValidEmail(email)) {
       return NextResponse.json(
         { error: "é‚®ç®±æ ¼å¼ä¸æ­£ç¡®" },
         { status: 400 }
diff --git a/app/api/ping/route.ts b/app/api/ping/route.ts
index d8b9345..7d3fc14 100644
--- a/app/api/ping/route.ts
+++ b/app/api/ping/route.ts
@@ -6,6 +6,7 @@ import {
 import { respData, respInvalidParams, respUnauthorized, respErr, ErrorCode } from "@/lib/resp";
 
 import { getUserUuid } from "@/services/user";
+import { log } from "@/lib/logger";
 
 // å®šä¹‰è¯·æ±‚ä½“ç±»å‹
 interface PingRequest {
@@ -17,6 +18,17 @@ interface PongResponse {
   pong: string;
 }
 
+// è½»é‡çº§ä¿æ´»ç«¯ç‚¹ - ç”¨äºå¤–éƒ¨ç›‘æ§æœåŠ¡
+export async function GET() {
+  return Response.json({
+    status: "alive",
+    timestamp: new Date().toISOString(),
+    uptime: process.uptime(),
+    version: "1.6.0" // ä»package.jsonè·å–
+  });
+}
+
+// åŸæœ‰çš„POSTç«¯ç‚¹ - ç”¨äºç”¨æˆ·åŠŸèƒ½æµ‹è¯•
 export async function POST(req: Request) {
   try {
     const body: PingRequest = await req.json();
@@ -49,7 +61,7 @@ export async function POST(req: Request) {
 
     return respData(response);
   } catch (e) {
-    console.error("ping test failed:", e);
+    log.error("Pingæµ‹è¯•å¤±è´¥", e as Error, { endpoint: "/api/ping" });
     return respErr("æµ‹è¯•å¤±è´¥ï¼Œè¯·ç¨åå†è¯•", ErrorCode.INTERNAL_ERROR);
   }
 }
diff --git a/app/api/reset-password/route.ts b/app/api/reset-password/route.ts
index 1c6e274..58b901d 100644
--- a/app/api/reset-password/route.ts
+++ b/app/api/reset-password/route.ts
@@ -3,6 +3,7 @@ import { findEmailVerification, markEmailVerificationAsUsed } from "@/models/ema
 import { findEmailUser, updateUserPassword } from "@/models/user";
 import { PASSWORD_CONFIG } from "@/lib/constants";
 import { log } from "@/lib/logger";
+import { isValidEmail } from "@/lib/email-validator";
 import bcrypt from "bcrypt";
 
 export async function POST(request: NextRequest) {
@@ -25,8 +26,7 @@ export async function POST(request: NextRequest) {
     }
 
     // éªŒè¯é‚®ç®±æ ¼å¼
-    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
-    if (!emailRegex.test(email)) {
+    if (!isValidEmail(email)) {
       return NextResponse.json(
         { error: "é‚®ç®±æ ¼å¼ä¸æ­£ç¡®" },
         { status: 400 }
diff --git a/app/api/send-email/route.ts b/app/api/send-email/route.ts
index 4ffae4e..4e69d7e 100644
--- a/app/api/send-email/route.ts
+++ b/app/api/send-email/route.ts
@@ -3,7 +3,7 @@
  * Email Sending API Route
  */
 
-import { respData, respErr } from "@/lib/resp";
+import { respData, respErr, respInvalidParams } from "@/lib/resp";
 import { sendEmailServer, testEmailServiceServer } from "@/lib/email-server";
 import { EmailType } from "@/types/email";
 import { getUserUuid, getUserEmail } from "@/services/user";
@@ -63,7 +63,7 @@ export async function POST(req: Request) {
     if (restrictToRegisteredUsers) {
       const recipientUser = await findUserByEmail(to);
       if (!recipientUser) {
-        return respErr("æ”¶ä»¶äººé‚®ç®±æœªæ³¨å†Œï¼Œè¯·å…³é—­ç”¨æˆ·é™åˆ¶é€‰é¡¹æˆ–ç¡®è®¤é‚®ç®±åœ°å€æ­£ç¡®");
+        return respInvalidParams("æ”¶ä»¶äººé‚®ç®±æœªæ³¨å†Œï¼Œè¯·å…³é—­ç”¨æˆ·é™åˆ¶é€‰é¡¹æˆ–ç¡®è®¤é‚®ç®±åœ°å€æ­£ç¡®");
       }
     }
 
diff --git a/app/api/send-verification-code/route.ts b/app/api/send-verification-code/route.ts
index 3c0a3cb..c142633 100644
--- a/app/api/send-verification-code/route.ts
+++ b/app/api/send-verification-code/route.ts
@@ -10,6 +10,7 @@ import { findEmailUser } from "@/models/user";
 import { getClientIp } from "@/lib/ip";
 import { EMAIL_VERIFICATION } from "@/lib/constants";
 import { log } from "@/lib/logger";
+import { isValidEmail } from "@/lib/email-validator";
 
 // é™åˆ¶å‘é€é¢‘ç‡çš„å†…å­˜å­˜å‚¨ï¼ˆç”Ÿäº§ç¯å¢ƒå»ºè®®ä½¿ç”¨Redisï¼‰
 const rateLimitMap = new Map<string, { count: number; resetTime: number }>();
@@ -93,8 +94,7 @@ export async function POST(request: NextRequest) {
     }
 
     // éªŒè¯é‚®ç®±æ ¼å¼
-    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
-    if (!emailRegex.test(email)) {
+    if (!isValidEmail(email)) {
       return NextResponse.json(
         { error: "é‚®ç®±æ ¼å¼ä¸æ­£ç¡®" },
         { status: 400 }
diff --git a/app/api/stripe-notify/route.ts b/app/api/stripe-notify/route.ts
index d9da13d..2c8feec 100644
--- a/app/api/stripe-notify/route.ts
+++ b/app/api/stripe-notify/route.ts
@@ -1,6 +1,7 @@
 import Stripe from "stripe";
 import { handleOrderSession } from "@/services/order";
 import { respOk } from "@/lib/resp";
+import { log } from "@/lib/logger";
 
 export async function POST(req: Request) {
   try {
@@ -25,7 +26,11 @@ export async function POST(req: Request) {
       stripeWebhookSecret
     );
 
-    console.log("stripe notify event: ", event);
+    log.info("stripe notify event received", {
+      eventType: event.type,
+      eventId: event.id,
+      function: 'stripe-notify'
+    });
 
     switch (event.type) {
       case "checkout.session.completed": {
@@ -36,12 +41,16 @@ export async function POST(req: Request) {
       }
 
       default:
-        console.log("not handle event: ", event.type);
+        log.info("unhandled stripe event", {
+          eventType: event.type,
+          eventId: event.id,
+          function: 'stripe-notify'
+        });
     }
 
     return respOk();
   } catch (e: any) {
-    console.log("stripe notify failed: ", e);
+    log.error("stripe notify failed", e as Error, { function: 'stripe-notify' });
     return Response.json(
       { error: `handle stripe notify failed: ${e.message}` },
       { status: 500 }
diff --git a/components/email/send-form.tsx b/components/email/send-form.tsx
index c62725c..d9e0e95 100644
--- a/components/email/send-form.tsx
+++ b/components/email/send-form.tsx
@@ -69,8 +69,8 @@ export function EmailSendForm({ onSuccess, defaultType, defaultTo }: EmailSendFo
 
       const result = await response.json();
 
-      if (result.success) {
-        toast.success('é‚®ä»¶å‘é€æˆåŠŸ');
+      if (result.code === 0 && result.data?.success) {
+        toast.success(result.data.message || 'é‚®ä»¶å‘é€æˆåŠŸ');
         // é‡ç½®è¡¨å•
         setFormData({
           type: EmailType.CUSTOM,
@@ -101,9 +101,9 @@ export function EmailSendForm({ onSuccess, defaultType, defaultTo }: EmailSendFo
 
       const result = await response.json();
 
-      if (result.success) {
-        toast.success('é‚®ä»¶æœåŠ¡æµ‹è¯•å®Œæˆ');
-        console.log('æµ‹è¯•ç»“æœ:', result.result);
+      if (result.code === 0 && result.data?.success) {
+        toast.success(result.data.message || 'é‚®ä»¶æœåŠ¡æµ‹è¯•å®Œæˆ');
+        console.log('æµ‹è¯•ç»“æœ:', result.data.result);
       } else {
         toast.error(result.message || 'é‚®ä»¶æœåŠ¡æµ‹è¯•å¤±è´¥');
       }
diff --git a/docs/ai-code-review-prompt.md b/docs/ai-code-review-prompt.md
index 877377f..d59cd2d 100644
--- a/docs/ai-code-review-prompt.md
+++ b/docs/ai-code-review-prompt.md
@@ -24,7 +24,7 @@
 - æ•°æ®éªŒè¯å’Œæ¸…ç†
 - SQL æ³¨å…¥é˜²æŠ¤
 - XSS æ”»å‡»é˜²æŠ¤
-- æ•æ„Ÿä¿¡æ¯æ³„éœ²
+- æ•æ„Ÿä¿¡æ¯æ³„éœ²ï¼ˆç”±äºæœ¬ä»“åº“åœ¨githubæ˜¯ç§æœ‰ä»“åº“ï¼Œå› æ­¤æ˜¯å®‰å…¨çš„ï¼‰
 - API æ¥å£å®‰å…¨
 - ç¯å¢ƒå˜é‡ä½¿ç”¨
 
diff --git a/models/credit.ts b/models/credit.ts
index 6d1b37a..a11939f 100644
--- a/models/credit.ts
+++ b/models/credit.ts
@@ -1,5 +1,5 @@
 import { Credit } from "@/types/credit";
-import { getSupabaseClient, withRequestDeduplication } from "@/models/db";
+import { getSupabaseClient } from "@/models/db";
 
 export async function insertCredit(credit: Credit) {
   const supabase = getSupabaseClient();
@@ -51,83 +51,20 @@ export async function findCreditByOrderNo(
 export async function getUserValidCredits(
   user_uuid: string
 ): Promise<Credit[] | undefined> {
-  // ä½¿ç”¨è¯·æ±‚å»é‡ï¼Œé¿å…åŒæ—¶æŸ¥è¯¢ç›¸åŒç”¨æˆ·çš„ç§¯åˆ†
-  return withRequestDeduplication(`getUserCredits:${user_uuid}`, async () => {
-    const maxRetries = 3;
-    let lastError: any = null;
-
-    for (let attempt = 1; attempt <= maxRetries; attempt++) {
-    try {
-      console.log(`[getUserValidCredits] å¼€å§‹æŸ¥è¯¢ç”¨æˆ·ç§¯åˆ† (å°è¯• ${attempt}/${maxRetries}), UUID:`, user_uuid);
-
-      const now = new Date().toISOString();
-      const supabase = getSupabaseClient();
-      const { data, error } = await supabase
-        .from("credits")
-        .select("*")
-        .eq("user_uuid", user_uuid)
-        .gte("expired_at", now)
-        .order("expired_at", { ascending: true });
-
-      if (error) {
-        console.error(`[getUserValidCredits] æ•°æ®åº“æŸ¥è¯¢é”™è¯¯ (å°è¯• ${attempt}):`, {
-          code: error.code,
-          message: error.message,
-          user_uuid
-        });
-
-        // å¦‚æœæ˜¯ç½‘ç»œé”™è¯¯æˆ–è¶…æ—¶é”™è¯¯ä¸”è¿˜æœ‰é‡è¯•æœºä¼šï¼Œç»§ç»­é‡è¯•
-        const isRetryableError = error.message.includes('fetch failed') ||
-                                error.message.includes('network') ||
-                                error.message.includes('TimeoutError') ||
-                                error.message.includes('timeout');
-
-        if (attempt < maxRetries && isRetryableError) {
-          lastError = error;
-          const retryDelay = attempt === 1 ? 500 : 1000;
-          console.log(`[getUserValidCredits] ç½‘ç»œ/è¶…æ—¶é”™è¯¯ï¼Œ${retryDelay}ms åé‡è¯•...`);
-
-          // åœ¨ç¬¬äºŒæ¬¡é‡è¯•æ—¶é‡ç½®è¿æ¥
-          if (attempt === 2) {
-            console.log(`[getUserValidCredits] é‡ç½®æ•°æ®åº“è¿æ¥`);
-            const { resetSupabaseClient } = require('./db');
-            resetSupabaseClient();
-          }
-
-          await new Promise(resolve => setTimeout(resolve, retryDelay));
-          continue;
-        }
-
-        return undefined;
-      }
-
-      console.log(`[getUserValidCredits] æŸ¥è¯¢æˆåŠŸ (å°è¯• ${attempt}), ç§¯åˆ†è®°å½•æ•°:`, data?.length || 0);
-      return data;
-    } catch (e) {
-      console.error(`[getUserValidCredits] æŸ¥è¯¢å¼‚å¸¸ (å°è¯• ${attempt}):`, e, "UUID:", user_uuid);
-      lastError = e;
-
-      // å¦‚æœè¿˜æœ‰é‡è¯•æœºä¼šï¼Œç»§ç»­é‡è¯•
-      if (attempt < maxRetries) {
-        const retryDelay = Math.min(1000 * Math.pow(2, attempt - 1), 3000);
-        console.log(`[getUserValidCredits] å¼‚å¸¸é”™è¯¯ï¼Œ${retryDelay}ms åé‡è¯•...`);
-
-        // åœ¨ç¬¬äºŒæ¬¡é‡è¯•æ—¶é‡ç½®è¿æ¥
-        if (attempt === 2) {
-          console.log(`[getUserValidCredits] é‡ç½®æ•°æ®åº“è¿æ¥`);
-          const { resetSupabaseClient } = require('./db');
-          resetSupabaseClient();
-        }
-
-        await new Promise(resolve => setTimeout(resolve, retryDelay));
-        continue;
-      }
-    }
+  const now = new Date().toISOString();
+  const supabase = getSupabaseClient();
+  const { data, error } = await supabase
+    .from("credits")
+    .select("*")
+    .eq("user_uuid", user_uuid)
+    .gte("expired_at", now)
+    .order("expired_at", { ascending: true });
+
+  if (error) {
+    throw error;
   }
 
-    console.error(`[getUserValidCredits] æ‰€æœ‰é‡è¯•éƒ½å¤±è´¥äº†, UUID: ${user_uuid}, æœ€åé”™è¯¯:`, lastError);
-    return undefined;
-  });
+  return data;
 }
 
 export async function getCreditsByUserUuid(
@@ -135,6 +72,9 @@ export async function getCreditsByUserUuid(
   page: number = 1,
   limit: number = 50
 ): Promise<Credit[] | undefined> {
+  if (page < 1) page = 1;
+  if (limit <= 0) limit = 50;
+
   const supabase = getSupabaseClient();
   const { data, error } = await supabase
     .from("credits")
diff --git a/models/db.ts b/models/db.ts
index 3a0d694..f174862 100644
--- a/models/db.ts
+++ b/models/db.ts
@@ -1,112 +1,99 @@
 import { createClient, SupabaseClient } from "@supabase/supabase-js";
+import { log } from "@/lib/logger";
 
-// å…¨å±€å®¢æˆ·ç«¯å®ä¾‹ï¼Œé¿å…é‡å¤åˆ›å»º
 let supabaseClient: SupabaseClient | null = null;
-let connectionAttempts = 0;
-let lastConnectionTime = 0;
-
-// è¯·æ±‚å»é‡ç¼“å­˜
-const requestCache = new Map<string, Promise<any>>();
-const cacheTimeout = 5000; // 5ç§’ç¼“å­˜
 
 export function getSupabaseClient() {
-  // å¦‚æœå·²æœ‰å®¢æˆ·ç«¯å®ä¾‹ï¼Œç›´æ¥è¿”å›
   if (supabaseClient) {
     return supabaseClient;
   }
 
-  connectionAttempts++;
-  lastConnectionTime = Date.now();
-  console.log(`[getSupabaseClient] åˆ›å»ºæ–°çš„æ•°æ®åº“è¿æ¥ (ç¬¬${connectionAttempts}æ¬¡)`);
-
-  const supabaseUrl = process.env.SUPABASE_URL || "";
-
-  let supabaseKey = process.env.SUPABASE_ANON_KEY || "";
-  if (process.env.SUPABASE_SERVICE_ROLE_KEY) {
-    supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY;
-  }
+  const supabaseUrl = process.env.SUPABASE_URL;
+  const supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY || process.env.SUPABASE_ANON_KEY;
 
   if (!supabaseUrl || !supabaseKey) {
     throw new Error("Supabase URL or key is not set");
   }
 
-  // åˆ›å»ºå®¢æˆ·ç«¯å®ä¾‹ - ä½¿ç”¨æœ€ç®€å•çš„é…ç½®ç¡®ä¿ç¨³å®šæ€§
   supabaseClient = createClient(supabaseUrl, supabaseKey, {
     auth: {
-      persistSession: false, // API è·¯ç”±ä¸­ä¸éœ€è¦æŒä¹…åŒ–ä¼šè¯
-    },
-    db: {
-      schema: 'public',
+      persistSession: false,
     },
   });
 
-  // è½»é‡çº§é¢„çƒ­è¿æ¥
-  if (process.env.NODE_ENV === 'development' && supabaseClient) {
-    setTimeout(async () => {
-      try {
-        console.log("[getSupabaseClient] é¢„çƒ­æ•°æ®åº“è¿æ¥...");
-        // ä½¿ç”¨æœ€ç®€å•çš„æŸ¥è¯¢è¿›è¡Œé¢„çƒ­
-        await supabaseClient!
-          .from('users')
-          .select('uuid')
-          .limit(1);
-        console.log("[getSupabaseClient] è¿æ¥é¢„çƒ­å®Œæˆ");
-      } catch (error) {
-        console.log("[getSupabaseClient] è¿æ¥é¢„çƒ­å¤±è´¥ï¼Œä½†ä¸å½±å“æ­£å¸¸ä½¿ç”¨");
-      }
-    }, 2000); // å»¶è¿Ÿ2ç§’ï¼Œç»™åº”ç”¨æ›´å¤šå¯åŠ¨æ—¶é—´
-  }
-
   return supabaseClient;
 }
 
-/**
- * é‡ç½®æ•°æ®åº“è¿æ¥ï¼ˆåœ¨è¿æ¥é—®é¢˜æ—¶ä½¿ç”¨ï¼‰
- */
+// é‡ç½®æ•°æ®åº“è¿æ¥ï¼ˆä»…ç”¨äºè°ƒè¯•ï¼‰
 export function resetSupabaseClient() {
-  console.log("[resetSupabaseClient] é‡ç½®æ•°æ®åº“è¿æ¥");
   supabaseClient = null;
-  // å¼ºåˆ¶åƒåœ¾å›æ”¶ï¼ˆå¦‚æœå¯ç”¨ï¼‰
-  if (global.gc) {
-    global.gc();
-  }
   return getSupabaseClient();
 }
 
-/**
- * è¯·æ±‚å»é‡åŒ…è£…å™¨
- */
-export function withRequestDeduplication<T>(
-  key: string,
-  requestFn: () => Promise<T>
+// è·å–è¿æ¥ç»Ÿè®¡ä¿¡æ¯ï¼ˆä»…ç”¨äºè°ƒè¯•ï¼‰
+export function getConnectionStats() {
+  return {
+    hasClient: !!supabaseClient,
+    timestamp: new Date().toISOString(),
+    nodeEnv: process.env.NODE_ENV,
+  };
+}
+
+// åˆ¤æ–­æ˜¯å¦ä¸ºå¯é‡è¯•çš„ç½‘ç»œé”™è¯¯
+function isRetryableNetworkError(error: any): boolean {
+  if (!error?.message) return false;
+
+  const message = error.message.toLowerCase();
+  return message.includes('fetch failed') ||
+         message.includes('network') ||
+         message.includes('timeout') ||
+         message.includes('econnreset') ||
+         message.includes('enotfound');
+}
+
+// é‡è¯•å·¥å…·å‡½æ•° - ä½¿ç”¨æŒ‡æ•°é€€é¿ç­–ç•¥
+export async function withRetry<T>(
+  operation: () => Promise<T>,
+  maxAttempts: number = 3
 ): Promise<T> {
-  // æ£€æŸ¥æ˜¯å¦æœ‰æ­£åœ¨è¿›è¡Œçš„ç›¸åŒè¯·æ±‚
-  if (requestCache.has(key)) {
-    console.log(`[withRequestDeduplication] å¤ç”¨è¿›è¡Œä¸­çš„è¯·æ±‚: ${key}`);
-    return requestCache.get(key)!;
-  }
+  let lastError: any;
+
+  for (let attempt = 1; attempt <= maxAttempts; attempt++) {
+    try {
+      return await operation();
+    } catch (error: any) {
+      lastError = error;
+
+      // å¦‚æœè¿˜æœ‰é‡è¯•æœºä¼šä¸”æ˜¯ç½‘ç»œé”™è¯¯ï¼Œåˆ™é‡è¯•
+      if (attempt < maxAttempts && isRetryableNetworkError(error)) {
+        // æŒ‡æ•°é€€é¿ï¼š1s, 2s, 4sï¼Œæœ€å¤§10s
+        const delay = Math.min(1000 * Math.pow(2, attempt - 1), 10000);
+        log.warn(`ç½‘ç»œé”™è¯¯ï¼Œ${delay}msåé‡è¯•`, {
+          attempt,
+          maxAttempts,
+          function: 'withRetry',
+          error: error.message,
+          delay
+        });
+        await new Promise(resolve => setTimeout(resolve, delay));
+        continue;
+      }
 
-  // åˆ›å»ºæ–°è¯·æ±‚
-  const promise = requestFn().finally(() => {
-    // è¯·æ±‚å®Œæˆåï¼Œå»¶è¿Ÿæ¸…é™¤ç¼“å­˜
-    setTimeout(() => {
-      requestCache.delete(key);
-    }, cacheTimeout);
-  });
+      // æœ€åä¸€æ¬¡å°è¯•å¤±è´¥ï¼Œæˆ–è€…ä¸æ˜¯ç½‘ç»œé”™è¯¯ï¼Œç›´æ¥æŠ›å‡º
+      throw error;
+    }
+  }
 
-  requestCache.set(key, promise);
-  return promise;
+  // ç†è®ºä¸Šä¸ä¼šåˆ°è¿™é‡Œï¼Œä½†ä¸ºäº†ç±»å‹å®‰å…¨
+  throw lastError;
 }
 
-/**
- * æ•°æ®åº“å¥åº·æ£€æŸ¥ - ä½¿ç”¨æœ€ç®€å•çš„æŸ¥è¯¢
- */
+// æ•°æ®åº“å¥åº·æ£€æŸ¥
 export async function checkDatabaseHealth() {
   try {
     const startTime = Date.now();
     const supabase = getSupabaseClient();
 
-    // ä½¿ç”¨æœ€ç®€å•çš„æŸ¥è¯¢ï¼Œåªæ£€æŸ¥è¿æ¥æ˜¯å¦å¯ç”¨
     const { error } = await supabase
       .from('users')
       .select('uuid')
@@ -115,7 +102,7 @@ export async function checkDatabaseHealth() {
 
     const latency = Date.now() - startTime;
 
-    // å¯¹äºå¥åº·æ£€æŸ¥ï¼ŒPGRST116 (not found) ä¹Ÿç®—æˆåŠŸï¼Œè¯´æ˜è¿æ¥æ­£å¸¸
+    // PGRST116 (not found) ä¹Ÿç®—æˆåŠŸï¼Œè¯´æ˜è¿æ¥æ­£å¸¸
     if (error && error.code !== 'PGRST116') {
       return { healthy: false, latency, error: error.message };
     }
@@ -125,45 +112,3 @@ export async function checkDatabaseHealth() {
     return { healthy: false, error: error.message };
   }
 }
-
-/**
- * åˆ¤æ–­é”™è¯¯æ˜¯å¦å¯é‡è¯•
- */
-export function isRetryableError(error: any): boolean {
-  if (!error) return false;
-
-  const message = error.message || '';
-  const code = error.code || '';
-
-  // ç½‘ç»œç›¸å…³é”™è¯¯
-  const networkErrors = [
-    'fetch failed',
-    'network',
-    'TimeoutError',
-    'timeout',
-    'ECONNRESET',
-    'ENOTFOUND',
-    'ECONNREFUSED'
-  ];
-
-  return networkErrors.some(errorType =>
-    message.includes(errorType) || code.includes(errorType)
-  );
-}
-
-/**
- * è·å–è¿æ¥ç»Ÿè®¡ä¿¡æ¯
- */
-export function getConnectionStats() {
-  return {
-    hasClient: !!supabaseClient,
-    connectionAttempts,
-    lastConnectionTime: lastConnectionTime ? new Date(lastConnectionTime).toISOString() : null,
-    timeSinceLastConnection: lastConnectionTime ? Date.now() - lastConnectionTime : null,
-    activeRequests: requestCache.size,
-    timestamp: new Date().toISOString(),
-    nodeEnv: process.env.NODE_ENV,
-  };
-}
-
-
diff --git a/models/user.ts b/models/user.ts
index b93806f..90be6fd 100644
--- a/models/user.ts
+++ b/models/user.ts
@@ -1,7 +1,8 @@
 import { User } from "@/types/user";
 import { getIsoTimestr } from "@/lib/time";
-import { getSupabaseClient, resetSupabaseClient, withRequestDeduplication, isRetryableError } from "./db";
+import { getSupabaseClient, withRetry } from "./db";
 import { log } from "@/lib/logger";
+import { isValidEmail, normalizeEmail, validateEmailOrThrow } from "@/lib/email-validator";
 
 export async function insertUser(user: User) {
   const supabase = getSupabaseClient();
@@ -18,151 +19,49 @@ export async function findUserByEmail(
   email: string
 ): Promise<User | undefined> {
   // éªŒè¯é‚®ç®±æ ¼å¼
-  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
-  if (!emailRegex.test(email)) {
-    log.error("Invalid email format", undefined, { email });
+  if (!isValidEmail(email)) {
+    log.error("Invalid email format", undefined, { email, function: 'findUserByEmail' });
     return undefined;
   }
 
-  const maxRetries = 3;
-  let lastError: any = null;
-
-  for (let attempt = 1; attempt <= maxRetries; attempt++) {
-    try {
-      log.debug(`å¼€å§‹æŸ¥è¯¢ç”¨æˆ· (å°è¯• ${attempt}/${maxRetries})`, { email, function: 'findUserByEmail' });
-
-      const supabase = getSupabaseClient();
-      const { data, error } = await supabase
-        .from("users")
-        .select("*")
-        .eq("email", email.toLowerCase().trim())
-        .limit(1)
-        .single();
-
-      if (error) {
-        // PGRST116 æ˜¯ "not found" é”™è¯¯ï¼Œè¿™æ˜¯æ­£å¸¸çš„ï¼Œä¸éœ€è¦é‡è¯•
-        if (error.code === 'PGRST116') {
-          console.log(`[findUserByEmail] ç”¨æˆ·ä¸å­˜åœ¨ (å°è¯• ${attempt}), Email:`, email);
-          return undefined;
-        }
-
-        console.error(`[findUserByEmail] æ•°æ®åº“æŸ¥è¯¢é”™è¯¯ (å°è¯• ${attempt}):`, {
-          code: error.code,
-          message: error.message,
-          details: error.details,
-          hint: error.hint,
-          email
-        });
-
-        // å¦‚æœæ˜¯ç½‘ç»œé”™è¯¯æˆ–è¶…æ—¶é”™è¯¯ä¸”è¿˜æœ‰é‡è¯•æœºä¼šï¼Œç»§ç»­é‡è¯•
-        const isRetryableError = error.message.includes('fetch failed') ||
-                                error.message.includes('network') ||
-                                error.message.includes('TimeoutError') ||
-                                error.message.includes('timeout');
-
-        if (attempt < maxRetries && isRetryableError) {
-          lastError = error;
-          const retryDelay = attempt === 1 ? 500 : 1000;
-          console.log(`[findUserByEmail] ç½‘ç»œ/è¶…æ—¶é”™è¯¯ï¼Œ${retryDelay}ms åé‡è¯•...`);
-          await new Promise(resolve => setTimeout(resolve, retryDelay));
-          continue;
-        }
-
-        // å…¶ä»–é”™è¯¯ç›´æ¥è¿”å› undefined
+  return withRetry(async () => {
+    const supabase = getSupabaseClient();
+    const { data, error } = await supabase
+      .from("users")
+      .select("*")
+      .eq("email", normalizeEmail(email))
+      .single();
+
+    if (error) {
+      // PGRST116 æ˜¯ "not found" é”™è¯¯ï¼Œè¿™æ˜¯æ­£å¸¸çš„
+      if (error.code === 'PGRST116') {
         return undefined;
       }
-
-      console.log(`[findUserByEmail] æŸ¥è¯¢æˆåŠŸ (å°è¯• ${attempt}), æ‰¾åˆ°ç”¨æˆ·:`, !!data);
-      return data;
-    } catch (e) {
-      console.error(`[findUserByEmail] æŸ¥è¯¢å¼‚å¸¸ (å°è¯• ${attempt}):`, e, "Email:", email);
-      lastError = e;
-
-      // å¦‚æœè¿˜æœ‰é‡è¯•æœºä¼šï¼Œç»§ç»­é‡è¯•
-      if (attempt < maxRetries) {
-        const retryDelay = attempt === 1 ? 500 : 1000;
-        console.log(`[findUserByEmail] å¼‚å¸¸é”™è¯¯ï¼Œ${retryDelay}ms åé‡è¯•...`);
-        await new Promise(resolve => setTimeout(resolve, retryDelay));
-        continue;
-      }
+      throw error;
     }
-  }
 
-  console.error(`[findUserByEmail] æ‰€æœ‰é‡è¯•éƒ½å¤±è´¥äº†, Email: ${email}, æœ€åé”™è¯¯:`, lastError);
-  return undefined;
+    return data;
+  });
 }
 
 export async function findUserByUuid(uuid: string): Promise<User | undefined> {
-  // ä½¿ç”¨è¯·æ±‚å»é‡ï¼Œé¿å…åŒæ—¶æŸ¥è¯¢ç›¸åŒç”¨æˆ·
-  return withRequestDeduplication(`findUser:${uuid}`, async () => {
-    const maxRetries = 3;
-    let lastError: any = null;
-
-    for (let attempt = 1; attempt <= maxRetries; attempt++) {
-    try {
-      console.log(`[findUserByUuid] å¼€å§‹æŸ¥è¯¢ç”¨æˆ· (å°è¯• ${attempt}/${maxRetries}), UUID:`, uuid);
-
-      const supabase = getSupabaseClient();
-      const { data, error } = await supabase
-        .from("users")
-        .select("*")
-        .eq("uuid", uuid)
-        .single();
-
-      if (error) {
-        console.error(`[findUserByUuid] æ•°æ®åº“æŸ¥è¯¢é”™è¯¯ (å°è¯• ${attempt}):`, {
-          code: error.code,
-          message: error.message,
-          details: error.details,
-          hint: error.hint,
-          uuid
-        });
-
-        // å¦‚æœæ˜¯ç½‘ç»œé”™è¯¯æˆ–è¶…æ—¶é”™è¯¯ä¸”è¿˜æœ‰é‡è¯•æœºä¼šï¼Œç»§ç»­é‡è¯•
-        if (attempt < maxRetries && isRetryableError(error)) {
-          lastError = error;
-          // ä½¿ç”¨æ¸è¿›çš„é‡è¯•é—´éš”ï¼š500ms, 1000ms
-          const retryDelay = attempt === 1 ? 500 : 1000;
-          console.log(`[findUserByUuid] ç½‘ç»œ/è¶…æ—¶é”™è¯¯ï¼Œ${retryDelay}ms åé‡è¯•...`);
-
-          // åœ¨ç¬¬äºŒæ¬¡é‡è¯•æ—¶é‡ç½®è¿æ¥ï¼ˆæ›´ä¿å®ˆçš„ç­–ç•¥ï¼‰
-          if (attempt === 2) {
-            console.log(`[findUserByUuid] é‡ç½®æ•°æ®åº“è¿æ¥`);
-            resetSupabaseClient();
-          }
-
-          await new Promise(resolve => setTimeout(resolve, retryDelay));
-          continue;
-        }
-
+  return withRetry(async () => {
+    const supabase = getSupabaseClient();
+    const { data, error } = await supabase
+      .from("users")
+      .select("*")
+      .eq("uuid", uuid)
+      .single();
+
+    if (error) {
+      // PGRST116 æ˜¯ "not found" é”™è¯¯ï¼Œè¿™æ˜¯æ­£å¸¸çš„
+      if (error.code === 'PGRST116') {
         return undefined;
       }
-
-      console.log(`[findUserByUuid] æŸ¥è¯¢æˆåŠŸ (å°è¯• ${attempt}), æ‰¾åˆ°ç”¨æˆ·:`, !!data);
-      return data;
-    } catch (e) {
-      console.error(`[findUserByUuid] æŸ¥è¯¢å¼‚å¸¸ (å°è¯• ${attempt}):`, e, "UUID:", uuid);
-      lastError = e;
-
-      // å¦‚æœè¿˜æœ‰é‡è¯•æœºä¼šï¼Œç»§ç»­é‡è¯•
-      if (attempt < maxRetries) {
-        const retryDelay = Math.min(1000 * Math.pow(2, attempt - 1), 3000);
-        console.log(`[findUserByUuid] å¼‚å¸¸é”™è¯¯ï¼Œ${retryDelay}ms åé‡è¯•...`);
-
-        // åœ¨ç¬¬äºŒæ¬¡é‡è¯•æ—¶é‡ç½®è¿æ¥
-        if (attempt === 2) {
-          console.log(`[findUserByUuid] é‡ç½®æ•°æ®åº“è¿æ¥`);
-          resetSupabaseClient();
-        }
-
-        await new Promise(resolve => setTimeout(resolve, retryDelay));
-        continue;
-      }
+      throw error;
     }
-  }
 
-    console.error(`[findUserByUuid] æ‰€æœ‰é‡è¯•éƒ½å¤±è´¥äº†, UUID: ${uuid}, æœ€åé”™è¯¯:`, lastError);
-    return undefined;
+    return data;
   });
 }
 
@@ -247,6 +146,11 @@ export async function findUserByInviteCode(invite_code: string) {
     .single();
 
   if (error) {
+    // PGRST116 æ˜¯ "not found" é”™è¯¯ï¼Œè¿™æ˜¯æ­£å¸¸çš„
+    if (error.code === 'PGRST116') {
+      return undefined;
+    }
+    log.error("Database error in findUserByInviteCode", error, { invite_code, function: 'findUserByInviteCode' });
     return undefined;
   }
 
@@ -290,10 +194,7 @@ export async function createEmailUser(user: User & { password_hash: string }) {
  */
 export async function verifyUserEmail(email: string) {
   // éªŒè¯é‚®ç®±æ ¼å¼
-  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
-  if (!emailRegex.test(email)) {
-    throw new Error("Invalid email format");
-  }
+  validateEmailOrThrow(email, 'verifyUserEmail');
 
   const supabase = getSupabaseClient();
   const updated_at = getIsoTimestr();
@@ -304,7 +205,7 @@ export async function verifyUserEmail(email: string) {
       email_verified_at: updated_at,
       updated_at,
     })
-    .eq("email", email.toLowerCase().trim())
+    .eq("email", normalizeEmail(email))
     .eq("signin_provider", "email");
 
   if (error) {
@@ -319,92 +220,29 @@ export async function verifyUserEmail(email: string) {
  */
 export async function findEmailUser(email: string): Promise<User | undefined> {
   // éªŒè¯é‚®ç®±æ ¼å¼
-  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
-  if (!emailRegex.test(email)) {
-    console.error("Invalid email format:", email);
+  if (!isValidEmail(email)) {
+    log.error("Invalid email format", undefined, { email, function: 'findEmailUser' });
     return undefined;
   }
 
-  const maxRetries = 3;
-  let lastError: any = null;
-
-  for (let attempt = 1; attempt <= maxRetries; attempt++) {
-    try {
-      console.log(`[findEmailUser] å¼€å§‹æŸ¥è¯¢é‚®ç®±ç”¨æˆ· (å°è¯• ${attempt}/${maxRetries}), Email:`, email);
-
-      const supabase = getSupabaseClient();
-      const { data, error } = await supabase
-        .from("users")
-        .select("*")
-        .eq("email", email.toLowerCase().trim())
-        .eq("signin_provider", "email")
-        .limit(1)
-        .single();
-
-      if (error) {
-        // PGRST116 æ˜¯ "not found" é”™è¯¯ï¼Œè¿™æ˜¯æ­£å¸¸çš„ï¼Œä¸éœ€è¦é‡è¯•
-        if (error.code === 'PGRST116') {
-          console.log(`[findEmailUser] ç”¨æˆ·ä¸å­˜åœ¨ (å°è¯• ${attempt}), Email:`, email);
-          return undefined;
-        }
-
-        console.error(`[findEmailUser] æ•°æ®åº“æŸ¥è¯¢é”™è¯¯ (å°è¯• ${attempt}):`, {
-          code: error.code,
-          message: error.message,
-          details: error.details,
-          hint: error.hint,
-          email
-        });
-
-        // å¦‚æœæ˜¯ç½‘ç»œé”™è¯¯æˆ–è¶…æ—¶é”™è¯¯ä¸”è¿˜æœ‰é‡è¯•æœºä¼šï¼Œç»§ç»­é‡è¯•
-        const isRetryableError = error.message.includes('fetch failed') ||
-                                error.message.includes('network') ||
-                                error.message.includes('TimeoutError') ||
-                                error.message.includes('timeout');
-
-        if (attempt < maxRetries && isRetryableError) {
-          lastError = error;
-          // ä½¿ç”¨æŒ‡æ•°é€€é¿ï¼š2s, 4s
-          const retryDelay = Math.pow(2, attempt) * 1000;
-          console.log(`[findEmailUser] ç½‘ç»œ/è¶…æ—¶é”™è¯¯ï¼Œ${retryDelay}ms åé‡è¯•...`);
-          await new Promise(resolve => setTimeout(resolve, retryDelay));
-          continue;
-        }
-
-        // å…¶ä»–é”™è¯¯ç›´æ¥è¿”å› undefined
-        return undefined;
-      }
+  const supabase = getSupabaseClient();
+  const { data, error } = await supabase
+    .from("users")
+    .select("*")
+    .eq("email", normalizeEmail(email))
+    .eq("signin_provider", "email")
+    .single();
 
-      console.log(`[findEmailUser] æŸ¥è¯¢æˆåŠŸ (å°è¯• ${attempt}), æ‰¾åˆ°ç”¨æˆ·:`, !!data);
-      return data;
-    } catch (e) {
-      console.error(`[findEmailUser] æŸ¥è¯¢å¼‚å¸¸ (å°è¯• ${attempt}):`, e, "Email:", email);
-      lastError = e;
-
-      // å¦‚æœè¿˜æœ‰é‡è¯•æœºä¼šï¼Œç»§ç»­é‡è¯•
-      if (attempt < maxRetries) {
-        const retryDelay = Math.pow(2, attempt) * 1000;
-        console.log(`[findEmailUser] å¼‚å¸¸é”™è¯¯ï¼Œ${retryDelay}ms åé‡è¯•...`);
-
-        // å¦‚æœæ˜¯ç¬¬äºŒæ¬¡é‡è¯•ï¼Œé‡ç½®æ•°æ®åº“è¿æ¥
-        if (attempt === 2) {
-          console.log("[findEmailUser] é‡ç½®æ•°æ®åº“è¿æ¥");
-          resetSupabaseClient();
-        }
-
-        await new Promise(resolve => setTimeout(resolve, retryDelay));
-        continue;
-      }
+  if (error) {
+    // PGRST116 æ˜¯ "not found" é”™è¯¯ï¼Œè¿™æ˜¯æ­£å¸¸çš„
+    if (error.code === 'PGRST116') {
+      return undefined;
     }
+    log.error("Database error in findEmailUser", error, { email, function: 'findEmailUser' });
+    return undefined;
   }
 
-  console.error(`[findEmailUser] æ‰€æœ‰é‡è¯•éƒ½å¤±è´¥äº†, Email: ${email}, æœ€åé”™è¯¯:`, lastError);
-  console.error(`[findEmailUser] å»ºè®®æ£€æŸ¥ï¼š
-    1. Supabase æ•°æ®åº“è¿æ¥çŠ¶æ€
-    2. ç½‘ç»œè¿æ¥ç¨³å®šæ€§
-    3. æ•°æ®åº“è¿æ¥æ± é…ç½®
-    4. æ˜¯å¦éœ€è¦å‡çº§ Supabase è®¡åˆ’`);
-  return undefined;
+  return data;
 }
 
 /**
@@ -412,10 +250,7 @@ export async function findEmailUser(email: string): Promise<User | undefined> {
  */
 export async function updateUserPassword(email: string, password_hash: string) {
   // éªŒè¯é‚®ç®±æ ¼å¼
-  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
-  if (!emailRegex.test(email)) {
-    throw new Error("Invalid email format");
-  }
+  validateEmailOrThrow(email, 'updateUserPassword');
 
   // éªŒè¯å¯†ç å“ˆå¸Œä¸ä¸ºç©º
   if (!password_hash || password_hash.trim().length === 0) {
@@ -430,7 +265,7 @@ export async function updateUserPassword(email: string, password_hash: string) {
       password_hash,
       updated_at,
     })
-    .eq("email", email.toLowerCase().trim())
+    .eq("email", normalizeEmail(email))
     .eq("signin_provider", "email");
 
   if (error) {
diff --git a/public/favicon.ico b/public/favicon.ico
index 80e3202..2244a45 100644
Binary files a/public/favicon.ico and b/public/favicon.ico differ
diff --git a/public/logo.png b/public/logo.png
index 80e3202..039e475 100644
Binary files a/public/logo.png and b/public/logo.png differ
diff --git a/services/credit.ts b/services/credit.ts
index 025ac5d..02bf513 100644
--- a/services/credit.ts
+++ b/services/credit.ts
@@ -11,6 +11,7 @@ import { findUserByUuid } from "@/models/user";
 import { getFirstPaidOrderByUserUuid } from "@/models/order";
 import { getIsoTimestr } from "@/lib/time";
 import { getSnowId } from "@/lib/hash";
+import { log } from "@/lib/logger";
 
 export enum CreditsTransType {
   NewUser = "new_user", // initial credits for new user
@@ -30,16 +31,20 @@ export async function getUserCredits(user_uuid: string): Promise<UserCredits> {
   };
 
   try {
-    console.log("[getUserCredits] å¼€å§‹è·å–ç”¨æˆ·ç§¯åˆ†, UUID:", user_uuid);
+    log.debug("å¼€å§‹è·å–ç”¨æˆ·ç§¯åˆ†", { user_uuid, function: 'getUserCredits' });
 
     const first_paid_order = await getFirstPaidOrderByUserUuid(user_uuid);
     if (first_paid_order) {
       user_credits.is_recharged = true;
-      console.log("[getUserCredits] ç”¨æˆ·å·²å……å€¼");
+      log.debug("ç”¨æˆ·å·²å……å€¼", { user_uuid, function: 'getUserCredits' });
     }
 
     const credits = await getUserValidCredits(user_uuid);
-    console.log("[getUserCredits] è·å–æœ‰æ•ˆç§¯åˆ†è®°å½•:", credits?.length || 0, "æ¡");
+    log.debug("è·å–æœ‰æ•ˆç§¯åˆ†è®°å½•", {
+      user_uuid,
+      creditsCount: credits?.length || 0,
+      function: 'getUserCredits'
+    });
 
     if (credits) {
       credits.forEach((v: Credit) => {
@@ -55,10 +60,16 @@ export async function getUserCredits(user_uuid: string): Promise<UserCredits> {
       user_credits.is_pro = true;
     }
 
-    console.log("[getUserCredits] ç§¯åˆ†è®¡ç®—å®Œæˆ:", user_credits);
+    log.info("ç§¯åˆ†è®¡ç®—å®Œæˆ", {
+      user_uuid,
+      left_credits: user_credits.left_credits,
+      is_pro: user_credits.is_pro,
+      is_recharged: user_credits.is_recharged,
+      function: 'getUserCredits'
+    });
     return user_credits;
   } catch (e) {
-    console.error("[getUserCredits] è·å–ç”¨æˆ·ç§¯åˆ†å¤±è´¥, UUID:", user_uuid, "é”™è¯¯:", e);
+    log.error("è·å–ç”¨æˆ·ç§¯åˆ†å¤±è´¥", e as Error, { user_uuid, function: 'getUserCredits' });
     return user_credits;
   }
 }
@@ -105,7 +116,7 @@ export async function decreaseCredits({
     };
     await insertCredit(new_credit);
   } catch (e) {
-    console.log("decrease credits failed: ", e);
+    log.error("æ‰£å‡ç§¯åˆ†å¤±è´¥", e as Error, { user_uuid, trans_type, credits, function: 'decreaseCredits' });
     throw e;
   }
 }
@@ -135,7 +146,7 @@ export async function increaseCredits({
     };
     await insertCredit(new_credit);
   } catch (e) {
-    console.log("increase credits failed: ", e);
+    log.error("å¢åŠ ç§¯åˆ†å¤±è´¥", e as Error, { user_uuid, trans_type, credits, function: 'increaseCredits' });
     throw e;
   }
 }
@@ -156,7 +167,12 @@ export async function updateCreditForOrder(order: Order) {
       order_no: order.order_no,
     });
   } catch (e) {
-    console.log("update credit for order failed: ", e);
+    log.error("æ›´æ–°è®¢å•ç§¯åˆ†å¤±è´¥", e as Error, {
+      order_no: order.order_no,
+      user_uuid: order.user_uuid,
+      credits: order.credits,
+      function: 'updateCreditForOrder'
+    });
     throw e;
   }
 }
diff --git a/services/order.ts b/services/order.ts
index a8d242b..2891270 100644
--- a/services/order.ts
+++ b/services/order.ts
@@ -10,6 +10,7 @@ import Stripe from "stripe";
 import { updateAffiliateForOrder } from "./affiliate";
 import { emailService } from "./email";
 import { findUserByUuid } from "@/models/user";
+import { log } from "@/lib/logger";
 
 export async function handleOrderSession(session: Stripe.Checkout.Session) {
   try {
@@ -58,26 +59,27 @@ export async function handleOrderSession(session: Stripe.Checkout.Session) {
         })
           .then((success) => {
             if (success) {
-              console.log(`è®¢å•ç¡®è®¤é‚®ä»¶å‘é€æˆåŠŸ: ${emailTo} - ${order_no}`);
+              log.info("è®¢å•ç¡®è®¤é‚®ä»¶å‘é€æˆåŠŸ", { emailTo, order_no, function: 'handleOrderSession' });
             } else {
-              console.log(`è®¢å•ç¡®è®¤é‚®ä»¶å‘é€å¤±è´¥: ${emailTo} - ${order_no}`);
+              log.warn("è®¢å•ç¡®è®¤é‚®ä»¶å‘é€å¤±è´¥", { emailTo, order_no, function: 'handleOrderSession' });
             }
           })
           .catch((error) => {
-            console.error(`è®¢å•ç¡®è®¤é‚®ä»¶å‘é€å¼‚å¸¸: ${emailTo} - ${order_no}`, error);
+            log.error("è®¢å•ç¡®è®¤é‚®ä»¶å‘é€å¼‚å¸¸", error, { emailTo, order_no, function: 'handleOrderSession' });
           });
       }
     }
 
-    console.log(
-      "handle order session successed: ",
+    log.info("è®¢å•å¤„ç†æˆåŠŸ", {
       order_no,
       paid_at,
       paid_email,
-      paid_detail
-    );
+      user_uuid: order.user_uuid,
+      credits: order.credits,
+      function: 'handleOrderSession'
+    });
   } catch (e) {
-    console.log("handle order session failed: ", e);
+    log.error("handle order session failed", e as Error, { function: 'handleOrderSession' });
     throw e;
   }
 }
diff --git a/services/user.ts b/services/user.ts
index 838a038..38c4337 100644
--- a/services/user.ts
+++ b/services/user.ts
@@ -31,13 +31,13 @@ export async function saveUser(user: User) {
         emailService.sendWelcomeEmail(user.email, user.nickname || undefined)
           .then((success) => {
             if (success) {
-              console.log(`æ¬¢è¿é‚®ä»¶å‘é€æˆåŠŸ: ${user.email}`);
+              log.info("æ¬¢è¿é‚®ä»¶å‘é€æˆåŠŸ", { email: user.email });
             } else {
-              console.log(`æ¬¢è¿é‚®ä»¶å‘é€å¤±è´¥: ${user.email}`);
+              log.warn("æ¬¢è¿é‚®ä»¶å‘é€å¤±è´¥", { email: user.email });
             }
           })
           .catch((error) => {
-            console.error(`æ¬¢è¿é‚®ä»¶å‘é€å¼‚å¸¸: ${user.email}`, error);
+            log.error("æ¬¢è¿é‚®ä»¶å‘é€å¼‚å¸¸", error, { email: user.email });
           });
       }
     } else {
@@ -48,7 +48,7 @@ export async function saveUser(user: User) {
 
     return user;
   } catch (e) {
-    console.log("save user failed: ", e);
+    log.error("save user failed", e as Error, { email: user.email });
     throw e;
   }
 }
