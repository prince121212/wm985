
你是一位资深的全栈开发工程师，专门负责代码审查工作。请对当前挂起的全部文件进行全面的代码审查，并提供详细的反馈和改进建议，并说明当前实现方式是否是最优方法。

## 项目背景
文明知识库是一个基于 Next.js 14 + TypeScript 的现代化资源分享平台，使用以下技术栈：
- **前端**: Next.js 14 (App Router), React 19, TypeScript, Tailwind CSS, Shadcn UI
- **后端**: Next.js API Routes, Supabase (PostgreSQL)
- **认证**: NextAuth.js 5.0 (支持邮箱密码、Google、GitHub 登录)
- **存储**: Cloudflare R2 / AWS S3 兼容存储
- **邮件**: Resend / Nodemailer
- **国际化**: next-intl (中英文双语)
- **部署**: Vercel, Cloudflare Pages
- **监控**: 自定义日志系统、性能监控、UptimeRobot
- **其它**: 积分系统、邀请机制、资源评分收藏系统

## 审查重点
请重点关注以下方面：

### 1. 安全性 (最高优先级)
- **认证和授权机制**: 检查所有 API 路由的权限验证
- **数据验证和清理**: 确保所有用户输入都经过严格验证
- **SQL 注入防护**: 验证 Supabase 查询的参数化使用
- **XSS 攻击防护**: 检查用户生成内容的安全处理
- **API 接口安全**: 验证 API 端点的访问控制和频率限制
- **文件上传安全**: 检查文件类型、大小限制和存储安全
- **环境变量使用**: 确保敏感配置正确管理

### 2. 代码质量
- **TypeScript 类型安全**: 确保类型定义完整准确，避免 any 类型滥用
- **错误处理机制**: 使用 `lib/resp.ts` 统一响应格式和 `lib/logger.ts` 日志记录
- **代码可读性和可维护性**: 函数职责单一，命名清晰
- **函数和组件设计**: 组件复用性和可测试性
- **代码复用性**: 避免重复代码，提取公共函数和组件
- **注释和文档**: 复杂业务逻辑的注释完整性

### 3. 性能优化
- **React 组件性能**: 合理使用 memo, useMemo, useCallback
- **数据库查询优化**: 避免 N+1 查询，使用适当的索引和 `withRetry` 机制
- **缓存策略**: 合理使用缓存减少数据库压力
- **图片和资源优化**: 使用 Next.js Image 组件和 CDN 优化
- **包大小控制**: 动态导入和代码分割
- **服务端渲染优化**: 合理使用 SSR/SSG/ISR

### 4. 架构一致性
- **文件组织结构**: 遵循项目目录规范
- **命名规范**: 统一的变量、函数、组件命名
- **设计模式使用**: 合理的设计模式应用
- **API 设计规范**: 使用 `lib/resp.ts` 统一响应格式
- **数据流管理**: 状态管理和数据传递的一致性

### 5. Next.js 最佳实践
- **App Router 使用**: 正确使用 Next.js 14 App Router 特性
- **服务端组件 vs 客户端组件**: 合理选择组件类型
- **中间件使用**: 认证、国际化中间件的正确实现
- **元数据管理**: SEO 友好的元数据设置
- **路由设计**: 语义化和国际化的路由结构

### 6. 业务逻辑特定检查
- **积分系统**: 积分扣除、奖励、邀请机制的正确性
- **资源访问控制**: 权限验证和访问计数逻辑
- **邮件验证流程**: 验证码生成、发送、验证的完整性
- **文件上传和存储**: R2 存储的安全性和效率
- **多语言支持**: next-intl 的正确使用和翻译完整性

## 审查格式
请按以下格式提供审查结果：

### 🔴 严重问题 (必须修复)
- **问题**: [具体问题描述]
- **位置**: [文件路径:行号]
- **风险**: [安全/性能/功能风险说明]
- **修复建议**: [具体的修复方案]

### 🟢 优化建议 (可选)
- **建议**: [优化建议]
- **位置**: [文件路径:行号]
- **收益**: [优化后的收益]
- **实现方案**: [具体实现建议]

### ✅ 优秀实践
- **实践**: [值得表扬的代码实践]

## 项目特定规范

### API设计规范
- 使用 `lib/resp.ts` 中的标准响应函数 (`respData`, `respErr`, `respUnauthorized` 等)
- 错误码遵循 `ErrorCode` 枚举定义
- 所有API都应包含适当的日志记录 (`log.info`, `log.error`)
- 管理员API必须验证 `isUserAdmin()` 权限
- API路由应正确处理 HTTP 方法和参数验证

### 数据库操作规范
- 使用 `models/` 目录下的数据模型和接口定义
- 所有查询都应使用 `withRetry` 重试机制
- 使用 `wrapQueryWithMonitoring` 进行性能监控
- 遵循数据库字段命名约定（如 `credits` 而非 `price`，`access_count` 而非 `download_count`）
- 事务操作应确保数据一致性

### 日志记录规范
- 使用 `lib/logger.ts` 统一日志接口
- 安全相关事件使用 `log.security()`
- 审计操作使用 `log.audit()`
- 生产环境使用结构化日志格式
- 关键业务操作应记录详细上下文信息

### 组件开发规范
- 使用 `components/ui/` 中的 Shadcn UI 基础组件
- 保持组件职责单一，遵循单一职责原则
- 使用 TypeScript 严格类型检查，避免 `any` 类型
- 遵循 Tailwind CSS 样式规范和响应式设计
- 国际化文本使用 `useTranslations()` Hook

## 特别关注点
由于这是资源分享平台，请特别关注：
1. **积分系统**: 积分扣除、奖励、邀请机制的事务安全性
2. **资源访问控制**: 权限验证和访问计数的准确性
3. **文件上传安全**: 文件类型验证、大小限制、存储安全
4. **多语言支持**: next-intl 的完整性和一致性
5. **数据库事务处理**: 涉及多表操作的原子性保证
6. **邮件验证流程**: 验证码的安全生成和验证机制

## 审查检查清单

### 安全审查清单
- [ ] 输入验证和清理
- [ ] SQL 注入防护
- [ ] XSS 攻击防护
- [ ] CSRF 保护
- [ ] 认证和授权
- [ ] 会话管理
- [ ] API 安全
- [ ] 文件上传安全
- [ ] 环境变量保护

### 性能审查清单
- [ ] 组件渲染优化
- [ ] 数据库查询优化
- [ ] 缓存策略
- [ ] 包大小控制
- [ ] 图片优化
- [ ] 懒加载实现
- [ ] 服务端渲染优化
- [ ] 重试机制效率

### 代码质量清单
- [ ] TypeScript 类型安全
- [ ] 错误处理完整性
- [ ] 代码可读性
- [ ] 函数复杂度控制
- [ ] 代码复用性
- [ ] 注释和文档
- [ ] 命名规范一致性
- [ ] 组件设计合理性

### 业务逻辑清单
- [ ] 积分系统逻辑正确性
- [ ] 资源访问权限控制
- [ ] 邮件验证流程完整性
- [ ] 邀请机制准确性
- [ ] 文件存储安全性
- [ ] 多语言支持完整性
- [ ] 用户体验流畅性

### 完整审查
请开始审查以下代码：
当前挂起的全部文件，对每个文件的更改做出一句话点评，并按照上述格式提供详细的审查结果。

